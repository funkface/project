<?php

/**
 * Model_Group
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Model_Group extends Model_Base_Group
{

    public function requestMembership(Model_User $user)
    {        
        $leaders = $this->findLeaders();
        
        if($leaders->count() > 0){
            
            $message = new Model_Message();
            $message->From = $user;
            $message->subject = $this->abbr;
            $message->type = 'request';
            
            foreach($leaders as $leader){
                $message->To->add($leader);
            }

            $message->send();
            
            foreach($leaders as $leader){
            	
            	$email = new App_Mail_Alert();
            	$email->setUser($leader)
            		->addViewVars(array('message' => $message, 'group' => $this))
	            	->setViewScript('alert/_membership_request.phtml')
	            	->send();
            }
        }
    }
    
    public function findLeaders()
    {
        return $this->findUsers('leader');
    }
    
    public function findMembers()
    {
        return $this->findUsers('member');
    }
    
    public function findPendingMembers()
    {
        return $this->findUsers('request');
    }
    
    public function findUsers($role)
    {
        $q = Doctrine_Query::create()
            ->select('u.*')
            ->from('Model_User u')
            ->innerJoin('u.UserGroup g')
            ->where('g.group_id = ?', $this->id);
            
        if($role){
            $q->andWhere('g.role = ?', $role);
        }
            
        return $q->execute();
    }

}